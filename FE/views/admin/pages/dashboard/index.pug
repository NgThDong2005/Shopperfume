extends ../../layouts/default.pug

block main
  h1= pageTitle

  // Tổng quan bằng card thay vì doughnut chart
  .row.mt-4
    .col-3
      .card.text-center.shadow-sm.mb-4
        .card-body
          i.fas.fa-users.fa-2x.text-primary.mb-2
          h5.mb-1 Khách hàng
          h3.text-dark #{totalUsers}

    .col-3
      .card.text-center.shadow-sm.mb-4
        .card-body
          i.fas.fa-boxes.fa-2x.text-success.mb-2
          h5.mb-1 Sản phẩm
          h3.text-dark #{totalProducts}

    .col-3
      .card.text-center.shadow-sm.mb-4
        .card-body
          i.fas.fa-tags.fa-2x.text-warning.mb-2
          h5.mb-1 Thương hiệu
          h3.text-dark #{totalBrands}

    .col-3
      .card.text-center.shadow-sm.mb-4
        .card-body
          i.fas.fa-th-list.fa-2x.text-danger.mb-2
          h5.mb-1 Danh mục
          h3.text-dark #{totalCategories}

  // Biểu đồ chi tiết
  .row.mt-4
    .col-6
      .card.mb-4
        .card-header Thống kê sản phẩm theo thương hiệu
        .card-body
          canvas#productsByBrandChart(width="400" height="200")

    .col-6
      .card.mb-4
        .card-header Thống kê sản phẩm theo danh mục
        .card-body
          canvas#productsByCategoryChart(width="400" height="200")


  script(src="https://cdn.jsdelivr.net/npm/chart.js")

  script.
    const productsByBrand = !{JSON.stringify(productsByBrand)};
    const productsByCategory = !{JSON.stringify(productsByCategory)};

    const colorPalette = [
      "#007bff", 
      "#dc3545", 
      "#28a745", 
      "#ffc107",
      "#6f42c1", 
      "#17a2b8", 
      "#fd7e14", 
      "#20c997", 
      "#e83e8c", 
      "#343a40"  
    ];

    function getRandomColors(palette, count) {
      const colors = [...palette]; 
      const selected = [];

      for (let i = 0; i < count && colors.length > 0; i++) {
        const randIndex = Math.floor(Math.random() * colors.length);
        selected.push(colors[randIndex]);
        colors.splice(randIndex, 1); 
      }

      return selected;
    }

    const brandColors = getRandomColors(colorPalette, productsByBrand.length);

    new Chart(document.getElementById('productsByBrandChart'), {
      type: 'bar',
      data: {
        labels: productsByBrand.map(b => b.brandName),
        datasets: [{
          label: 'Sản phẩm',
          data: productsByBrand.map(b => b.count),
          backgroundColor: brandColors
        }]
      }
    });

    const mapping = {
      male: "Nam",
      female: "Nữ"
    };

    new Chart(document.getElementById('productsByCategoryChart'), {
      type: 'bar',
      data: {
        labels: productsByCategory.map(c => {
          const key = c.categoryName?.trim().toLowerCase();
          return mapping[key] || c.categoryName;
        }),
        datasets: [{
          label: 'Sản phẩm',
          data: productsByCategory.map(c => c.count),
          backgroundColor: productsByCategory.map(c => {
            const key = c.categoryName?.trim().toLowerCase();
            if (key === "male") return "blue";       
            if (key === "female") return "pink";    
            return "#6f42c1";                       
          })
        }]
      }
    });
