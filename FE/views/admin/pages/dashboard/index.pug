extends ../../layouts/default.pug

block main
  h1= pageTitle

  .row.mt-4
    .col-3
      .card.mb-4
        .card-header Khách hàng
        .card-body
          p Tổng: <b>#{totalUsers}</b>
          canvas#userChart(width="200" height="200")

    .col-3
      .card.mb-4
        .card-header Sản phẩm
        .card-body
          p Tổng: <b>#{totalProducts}</b>
          canvas#productChart(width="200" height="200")

    .col-3
      .card.mb-4
        .card-header Thương hiệu
        .card-body
          p Tổng: <b>#{totalBrands}</b>
          canvas#brandChart(width="200" height="200")

    .col-3
      .card.mb-4
        .card-header Danh mục
        .card-body
          p Tổng: <b>#{totalCategories}</b>
          canvas#categoryChart(width="200" height="200")

  .row.mt-4
    .col-6
      .card.mb-4
        .card-header Thống kê sản phẩm theo thương hiệu
        .card-body
          canvas#productsByBrandChart(width="400" height="200")

    .col-6
      .card.mb-4
        .card-header Thống kê sản phẩm theo danh mục
        .card-body
          canvas#productsByCategoryChart(width="400" height="200")


  script(src="https://cdn.jsdelivr.net/npm/chart.js")

  script.
    // Data từ server -> biến JS
    const productsByBrand = !{JSON.stringify(productsByBrand)};
    const productsByCategory = !{JSON.stringify(productsByCategory)};
    const totalUsers = #{totalUsers};
    const totalProducts = #{totalProducts};
    const totalBrands = #{totalBrands};
    const totalCategories = #{totalCategories};

    // Chart tổng quan
    new Chart(document.getElementById('userChart'), {
      type: 'doughnut',
      data: {
        labels: ['Người dùng'],
        datasets: [{ data: [totalUsers], backgroundColor: ['#007bff'] }]
      }
    });

    new Chart(document.getElementById('productChart'), {
      type: 'doughnut',
      data: {
        labels: ['Sản phẩm'],
        datasets: [{ data: [totalProducts], backgroundColor: ['#28a745'] }]
      }
    });

    new Chart(document.getElementById('brandChart'), {
      type: 'doughnut',
      data: {
        labels: ['Thương hiệu'],
        datasets: [{ data: [totalBrands], backgroundColor: ['#ffc107'] }]
      }
    });

    new Chart(document.getElementById('categoryChart'), {
      type: 'doughnut',
      data: {
        labels: ['Danh mục'],
        datasets: [{ data: [totalCategories], backgroundColor: ['#dc3545'] }]
      }
    });

    const colorPalette = [
      "#007bff", 
      "#dc3545", 
      "#28a745", 
      "#ffc107",
      "#6f42c1", 
      "#17a2b8", 
      "#fd7e14", 
      "#20c997", 
      "#e83e8c", 
      "#343a40"  
    ];

    function getRandomColors(palette, count) {
      const colors = [...palette]; 
      const selected = [];

      for (let i = 0; i < count && colors.length > 0; i++) {
        const randIndex = Math.floor(Math.random() * colors.length);
        selected.push(colors[randIndex]);
        colors.splice(randIndex, 1); 
      }

      return selected;
    }


    const brandColors = getRandomColors(colorPalette, productsByBrand.length);


    new Chart(document.getElementById('productsByBrandChart'), {
      type: 'bar',
      data: {
        labels: productsByBrand.map(b => b.brandName),
        datasets: [{
          label: 'Sản phẩm',
          data: productsByBrand.map(b => b.count),
          backgroundColor: brandColors
        }]
      }
    });

    const mapping = {
      male: "Nam",
      female: "Nữ"
    };

    new Chart(document.getElementById('productsByCategoryChart'), {
      type: 'bar',
      data: {
        labels: productsByCategory.map(c => {
          const key = c.categoryName?.trim().toLowerCase();
          return mapping[key] || c.categoryName;
        }),
        datasets: [{
          label: 'Sản phẩm',
          data: productsByCategory.map(c => c.count),
          backgroundColor: productsByCategory.map(c => {
            const key = c.categoryName?.trim().toLowerCase();
            if (key === "male") return "blue";       
            if (key === "female") return "pink";    
            return "#6f42c1";                       
          })
        }]
      }
    });